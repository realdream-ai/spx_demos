var (
	// 个人信息
	home string // 家
	work string // 工作地
	role string // 角色

	// 角色信息
	roleInfo map[string]any // 角色设定

	// 基本属性
	energy    int // 精力 0-100
	hunger    int // 饥饿 0-100
	health    int // 健康 0-100
	happiness int // 快乐 0-100
	money     int // 金钱

	// 状态
	currentLocation  string    // 当前位置
	currentDirection Direction // 当前方向
	currentAction    Activity  // 当前动作
	targetLocation   string    // 目标位置
	isMoving         bool      // 是否在移动
	moveSpeed        float64   // 移动速度

	// 社交系统
	friendships   map[string]float64 // 朋友圈：名字 -> 友好度 (0-100)
	lastSpeakTime map[string]int     // 上次打招呼时间，避免频繁打招呼

	// 个性特征
	personality map[string]int // 个性
	curMovePath []float64
	curPathIdx int
)

// 个性属性
func initPersonality() {
	personality = {
		"workLove":   80, // 工作热爱度
		"socialNeed": 70, // 社交需求
		"healthCare": 60, // 健康关注度
		"sleepNeed":  50, // 睡眠需求
		"foodLove":   60, // 美食喜爱度
	}

	home = "house1"
	work = "farm"
	role = "Town Resident"

	roleInfo = {
		"name":        name,
		"personality": personality,
		"language":    "中文",
		"traits":      "hardworking and social",
		"occupation":  "farmer",
		"home":        home,
		"socialRules": "can greet nearby residents, values friendships",
	}
}

// 社交相关函数
func initFriendships() {
	friendships = {
		"Diana的小孩": 95,
		"Diana":    50,
		// "Smith":      85,
		"Alice":      85,
		"Charile":    90,
		"Charile的小孩": 95,
	}
	lastSpeakTime = {}
}

// 任务状态
func initStats() {
	energy = 80
	hunger = 30
	health = 90
	happiness = 70
	money = 100
	currentLocation = home
	currentAction = Idle
	currentDirection = Down
	isMoving = false
	moveSpeed = 1
}

// 状态：随时间自然变化
func updateStats() {
	if !isNightTime() {
		energy -= 2
		hunger += 3
	}

	if currentAction == Work {
		energy -= 5
		happiness -= 2
		hunger += 2
		money += 10
	} else if currentAction == Eat {
		hunger -= 30
		happiness += 10
	} else if currentAction == Sleep {
		energy += 20
		hunger += 1
	} else if currentAction == Socialize {
		happiness += 15
		energy -= 3
	} else if currentAction == Rest {
		energy += 10
		hunger += 1
	}

	// 确保数值在合理范围内
	if energy < 0 {
		energy = 0
	}
	if energy > 100 {
		energy = 100
	}
	if hunger < 0 {
		hunger = 0
	}
	if hunger > 100 {
		hunger = 100
	}
	if health < 0 {
		health = 0
	}
	if health > 100 {
		health = 100
	}
	if happiness < 0 {
		happiness = 0
	}
	if happiness > 100 {
		happiness = 100
	}
}

// 获取当前状态
func getCurrentStatus() map[string]any {
	return {
		"energy":          energy,
		"hunger":          hunger,
		"health":          health,
		"happiness":       happiness,
		"money":           money,
		"location":        currentLocation,
		"action":          currentAction,
		"time":            stringTime(),
		"isNight":         isNightTime(),
		"isMealTime":      isMealTime(),
		"isWorkTime":      isWorkTime(),
		"farmWorkNeeded":  farmWorkNeeded,
		"clinicBusy":      clinicBusy,
		"socialInfo":      getFriendshipStatus(),
		"nearbyResidents": getNearbyResidents(),
	}
}

func getCostume() string {
	if isMoving {
		return ""
	}

	if currentDirection == Up {
		return "up"
	}
	if currentDirection == Down {
		return "down"
	}
	if currentDirection == Left {
		return "left"
	}
	if currentDirection == Right {
		return "right"
	}
	return ""
}

// 获取当前动画
func getCurrentAnimation() string {
	if !isMoving {
		return ""
	}

	if currentDirection == Up {
		return "up"
	}
	if currentDirection == Down {
		return "down"
	}
	if currentDirection == Left {
		return "left"
	}
	if currentDirection == Right {
		return "right"
	}
	return ""
}

func canSpeakWith(targetName string) bool {
	// 检查是否刚刚交谈过（避免频繁交谈）
	currentTime := currentTime()
	if lastTime, ok := lastSpeakTime[targetName]; ok {
		if currentTime-lastTime < 15 { // 15分钟内不重复主动交谈
			return false
		}
	}
	return true
}

// 获取附近的人
func getNearbyResidents() *List {
	if isMoving || isOutdoorLocation(currentLocation) {
		// 户外 或正在移动 需要在一定范围内
		return getResidentsInRange(xpos, ypos, 200.0) // 200像素范围内
	} else {
		// 室内只要在同一场所
		residents := getResidentsInLocation(currentLocation)
		var result = &List{}
		for _, residentName := range residents {
			if residentName != name { // 排除自己
				result.append(name)
			}
		}
		return result
	}
}

// 与 $targetName 说话
func speakWithResident(targetName, msg string) {
	// 发送交谈请求
	broadcast "conversation_request", {
		"from":     name,
		"to":       targetName,
		"message":  msg,
		"location": currentLocation,
	}

	// 记录交谈时间
	lastSpeakTime[targetName] = currentTime()

	// 增加友好度和快乐度
	if friendship, ok := friendships[targetName]; ok {
		friendships[targetName] = min(friendship+3, 100)
	}
	happiness += 5

	message msg
}

// 获取朋友圈信息
func getFriendshipStatus() map[string]any {
	nearbyResidents := getNearbyResidents()
	friendList := []map[string]any{}

	for name, friendship := range friendships {
		friendList = append(friendList, {
			"name":       name,
			"friendship": friendship,
			"isNearby":   nearbyResidents.contains(name),
		})
	}

	return {
		"friends":         friendList,
		"nearbyResidents": nearbyResidents,
	}
}

// 方向获取函数
func getDirection(fromX, fromY, toX, toY float64) (Direction, float64) {
	deltaX := toX - fromX
	deltaY := toY - fromY

	if deltaX > 0 {
		return Right, deltaX
	} else if deltaX < 0 {
		return Left, abs(deltaX)
	} else if deltaY > 0 {
		return Up, deltaY
	} else if deltaY < 0 {
		return Down, abs(deltaY)
	}

	// 没动即为当前方向
	return currentDirection, 0.0
}

// 移动到目的地
func moveToLocation(location string) {
	if isMoving || currentLocation == location {
		return
	}

	targetLocation = location
	isMoving = true

	// 获取目标位置
	toX, toY := getLocation(location)
	if toX == 0 && toY == 0 {
		isMoving = false
		return
	}

	// 使用寻路算法 TODO
	path := findPath(xpos, ypos, toX, toY,false)

	// 开始移动
	moveAlongPath(path)
}


// 依照寻路路径移动
func moveAlongPath(movePath []float64) {
	// 路径数组格式：[x1,y1,x2,y2,x3,y3,...]
	// 每次循环处理一对坐标 (x,y)
	curMovePath = movePath
	curPathIdx = 0
	for pathIndex := 0; pathIndex < len(movePath)-1; pathIndex += 2 {
		nextX := movePath[pathIndex]
		nextY := movePath[pathIndex+1]
		// 移动到下一个点
		move(nextX, nextY)
		waitNextFrame
		curPathIdx = pathIndex
	}
	curMovePath = nil
	// 到达目标
	log "到达："+targetLocation
	currentLocation = targetLocation
	isMoving = false
	stopAnimation getCurrentAnimation()

	broadcast "resident_status", {
		"name":     name,
		"action":   "arrived at " + currentLocation,
		"location": currentLocation,
	}
}

// 移动到这个点
func move(x, y float64) {
	sx,sy := xpos, ypos
	dx,dy := x,y
	diffX := dx - sx
	diffY := dy - sy
	moveX := abs(diffX) > 0.1
	moveSpeed := 100.0
	totalTime := (abs(diffX) + abs(diffY)) / moveSpeed
	for {
		totalTime -= deltaTime
		if(totalTime <= 0){
			break
		}
		val := moveSpeed * deltaTime
		if(moveX ){
			if diffX > 0 {
				sx += val
			} else {
				sx -= val
			}
		}else{
			if(diffY >0){
				sy += val
			} else {
				sy -= val
			}
		}
		setXYpos sx,sy
		waitNextFrame
	}
	setXYpos dx,dy
	 
}

func updateStatusDisplay() {
	status := getCurrentStatus()

	// 格式化显示文本
	text := sprintf(`%s状态:
时间: %s
位置: %s
行动: %s
金钱：%d
精力: %d
饥饿: %d
健康: %d
快乐: %d
附近的朋友：%d`, name, status["time"].(string), status["location"].(string), status["action"].(Activity), status["money"].(int),
		status["energy"].(int), status["hunger"].(int), status["health"].(int), status["happiness"].(int), status["nearbyResidents"].(*List).len())

	// 更新监视器显示
	setStatusText text
}

func message(a any) {
	if followSprite == name {
		println name+":", a
	}
	say a
}

func log(a ...any) {
	if followSprite == name {
		a = append([]any{name + ":"}, a...)
		println a...
	}
}

// 注册 AI 命令
func onCmdGoTo(cmd CmdGoTo)  error {
	if isMoving {
		return errorf("我正在移动中，请稍后")
	}
	message cmd.Reason + " " + cmd.Location
	moveToLocation(cmd.Location)
	return nil
}

func onCmdActivity(cmd CmdActivity)  error {
	if isMoving {
		return errorf("我正在移动中，请稍后")
	}
	currentAction = getActivity(cmd.Activity)
	message currentAction+"..."

	// 根据活动类型执行相应逻辑
	if cmd.Activity == "work" && currentLocation == "farm" {
		broadcast "farm_work_done"
	} else if cmd.Activity == "eat" && currentLocation == "restaurant" {
		money -= 20
	} else if cmd.Activity == "shop" && currentLocation == "shop" {
		money -= 30
		happiness += 5
	}

	wait cmd.Duration/timeSpeed
	currentAction = Idle
	return nil
}

func onCmdSpeakWith(cmd CmdSpeakWith)  error {
	println "CmdSpeakWith:", cmd.TargetName, ":", cmd.Message
	if isMoving {
		return errorf("我正在移动中，无法交谈")
	}

	nearbyResidents := getNearbyResidents()
	if !nearbyResidents.contains(cmd.TargetName) {
		return errorf(cmd.TargetName + "不在附近，无法交谈")
	}

	if !canSpeakWith(cmd.TargetName) {
		return errorf("我刚刚已经和" + cmd.TargetName + "交谈过了")
	}

	speakWithResident(cmd.TargetName, cmd.Message)
	return nil
}
func doRand(min, max int) int {
	return int(rand(min, max))
}

func runAI(msg string, data any){
	println "think start ",msg
	say msg , 2
	// 随机选择执行一个命令（1-3）
	cmdChoice := doRand(1, 1) // TODO force set 1
	println "cmdChoice" ,cmdChoice
	
	if cmdChoice == 1 {
		// 随机执行 onCmdGoTo
		locations := []string{"farm", "clinic", "park", "shop", "restaurant", "house1", "house2", "house3"}
		reasons := []string{"去看看有什么有趣的", "想去这里走走", "需要去办点事", "想去放松一下", "去看看朋友"}
		
		location := locations[doRand(0, len(locations)-1)]
		reason := reasons[doRand(0, len(reasons)-1)]
		
		cmd := CmdGoTo{
			Location: location,
			Reason:   reason,
		}
		onCmdGoTo(cmd)
		
	} else if cmdChoice == 2 {
		// 随机执行 onCmdActivity
		activities := []string{"sleep", "eat", "work", "shop", "socialize", "exercise", "rest"}
		activity := activities[doRand(0, len(activities)-1)]
		duration := float64(doRand(2, 6)) // 10-60分钟
		
		cmd := CmdActivity{
			Activity: activity,
			Duration: duration,
		}
		onCmdActivity(cmd)
		
	} else {
		// 随机执行 onCmdSpeakWith
		nearbyResidents := getNearbyResidents()
		if nearbyResidents.len() > 0 {
			// 从附近的居民中随机选一个
			idx := doRand(0, nearbyResidents.Len()-1)
			targetName := nearbyResidents.At(idx).String()
			
			messages := []string{
				"你好！天气真不错呢！",
				"最近怎么样？",
				"今天过得如何？",
				"很高兴在这里遇到你！",
				"有什么新鲜事吗？",
				"这里真是个好地方呢！",
			}
			message := messages[doRand(0, len(messages)-1)]
			
			cmd := CmdSpeakWith{
				TargetName: targetName,
				Message:    message,
			}
			onCmdSpeakWith(cmd)
		} else {
			// 如果附近没有人，就执行其他活动
			activities := []string{"rest", "exercise", "work"}
			activity := activities[doRand(0, len(activities)-1)]
			duration := float64(doRand(10, 30))
			
			cmd := CmdActivity{
				Activity: activity,
				Duration: duration,
			}
			onCmdActivity(cmd)
		}
	}
	println "think done"
}
onStart => {
	initPersonality()
	initStats()
	initFriendships()

	// 设置初始位置
	setCostume getCostume()


	// 开始 AI 生活循环
	forever => {
		wait 2+rand(1, 2)
		if !isMoving && currentAction == Idle {
			runAI("我现在应该做什么？可以去一个地方，可以做一件事，如果附近有朋友的话，跟附近朋友打招呼～", getCurrentStatus())
		}
	}
}

onStart => {
	forever => {
		wait 2
		updateStats()
		// 如果视口是自己就更新状态信息到 monitor
		if followSprite == name {
			updateStatusDisplay()
		}
	}
}
onStart => {
	forever => {
		if(curMovePath != nil){
			debugDrawLines(curMovePath[curPathIdx:], HSB(0,100,100))
		}
		
	}
}

onClick => {
	if followSprite == name {
		updateStatusDisplay()
	}
	toggleStatus()
}

onMsg (msg, data) => {
	switch msg {
	case "hour_changed":
		hour := data.(int)
		if hour == 22 && currentLocation != home && !isMoving {
			runAI "现在很晚了，我应该回家睡觉", getCurrentStatus()
		} else if hour == 8 && currentLocation == home && currentAction == "rest" {
			runAI "新的一天开始了，我应该起床了", getCurrentStatus()
		} else if hour == 12 && currentLocation != "restaurant" && !isMoving {
			runAI "午餐时间到了，我有点饿了", getCurrentStatus()
		}
	case "time_update":
		updateStats()
	case "conversation_request":
		req := data.(map[string]any)
		if req["to"] == name {
			fromName := req["from"].(string)
			message := req["message"].(string)
			runAI sprintf("%s 跟你说了句话：%s, 回应一下他(她)吧", fromName, message), getCurrentStatus()
		}
	}
}
